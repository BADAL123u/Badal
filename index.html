<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BN LAST KING - Modern Prediction Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0F172A 0%, #1E293B 50%, #334155 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .glass-morphism {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .gradient-border {
            background: linear-gradient(135deg, #3B82F6, #8B5CF6, #EC4899);
            padding: 2px;
            border-radius: 16px;
        }

        .gradient-border > div {
            background: #1E293B;
            border-radius: 14px;
            padding: 1.5rem;
        }

        .neon-glow {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5), 0 0 40px rgba(59, 130, 246, 0.3);
        }

        .prediction-big {
            background: linear-gradient(135deg, #059669 0%, #10B981 100%);
            color: white;
            box-shadow: 0 10px 30px rgba(5, 150, 105, 0.4);
        }

        .prediction-small {
            background: linear-gradient(135deg, #DC2626 0%, #EF4444 100%);
            color: white;
            box-shadow: 0 10px 30px rgba(220, 38, 38, 0.4);
        }

        .status-win {
            background: linear-gradient(135deg, #059669, #10B981);
            color: white;
        }

        .status-loss {
            background: linear-gradient(135deg, #DC2626, #EF4444);
            color: white;
        }

        .status-pending {
            background: linear-gradient(135deg, #D97706, #F59E0B);
            color: white;
        }

        .floating-animation {
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .pulse-ring {
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            80%, 100% { transform: scale(1.2); opacity: 0; }
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .logic-selector {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
        }

        .logic-selector:hover {
            transform: translateY(-2px);
            border-color: #3B82F6;
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.2);
        }

        .logic-selector.active {
            background: linear-gradient(135deg, #3B82F6, #8B5CF6);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
        }

        .countdown-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #3B82F6, #8B5CF6, #EC4899, #3B82F6);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .countdown-inner {
            width: 100px;
            height: 100px;
            background: #1E293B;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            min-width: 350px;
            transform: translateX(400px);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .notification.show {
            transform: translateX(0);
        }

        .history-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .history-card:hover {
            transform: translateX(5px);
            background: rgba(255, 255, 255, 0.1);
        }

        .history-win {
            border-left-color: #10B981;
            background: rgba(16, 185, 129, 0.05);
        }

        .history-loss {
            border-left-color: #EF4444;
            background: rgba(239, 68, 68, 0.05);
        }

        .history-pending {
            border-left-color: #F59E0B;
            background: rgba(245, 158, 11, 0.05);
        }

        .metric-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 768px) {
            .notification {
                min-width: 320px;
                right: 10px;
            }
        }

        .loading-spinner {
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top: 3px solid #3B82F6;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-white">
    <!-- Notification -->
    <div id="notification" class="notification glass-morphism rounded-xl">
        <div class="flex items-start p-4">
            <div id="notificationIcon" class="mr-3 mt-1">
                <i class="fas fa-check-circle text-green-400 text-xl"></i>
            </div>
            <div class="flex-1">
                <div id="notificationTitle" class="font-semibold text-white mb-1"></div>
                <div id="notificationMessage" class="text-sm text-gray-300"></div>
            </div>
            <button onclick="hideNotification()" class="text-gray-400 hover:text-white ml-2">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <div class="min-h-screen p-4">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="flex items-center justify-center mb-4">
                <div class="pulse-ring absolute w-20 h-20 rounded-full bg-blue-500 opacity-20"></div>
                <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                    <i class="fas fa-crown text-2xl text-white"></i>
                </div>
            </div>
            <h1 class="text-5xl font-bold bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 bg-clip-text text-transparent mb-2">
                BN LAST KING
            </h1>
            <p class="text-xl text-gray-300 font-light">Advanced AI Prediction Dashboard</p>
            <div class="flex items-center justify-center mt-4">
                <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse mr-2"></div>
                <span class="text-green-400 font-medium">System Online</span>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="max-w-7xl mx-auto">
            <!-- Top Row - Current Prediction & Countdown -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- Current Prediction -->
                <div class="lg:col-span-2 gradient-border">
                    <div class="glass-morphism rounded-lg">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center">
                                <i class="fas fa-calendar-day text-2xl text-blue-400 mr-3"></i>
                                <div>
                                    <div class="text-sm text-gray-400">Current Period</div>
                                    <div class="text-2xl font-bold" id="currentPeriod">Loading...</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-400">AI Logic</div>
                                <div class="text-lg font-semibold text-purple-400" id="currentLogic">Ultra AI</div>
                            </div>
                        </div>

                        <div class="text-center mb-6">
                            <div class="text-sm text-gray-400 mb-2">AI Prediction</div>
                            <div id="predictionDisplay" class="inline-block px-8 py-4 rounded-2xl text-4xl font-bold prediction-big mb-4">
                                BIG
                            </div>
                            <div class="grid grid-cols-2 gap-6 mt-4">
                                <div class="text-center">
                                    <div class="text-sm text-gray-400 mb-1">Target Number</div>
                                    <div class="text-3xl font-bold text-yellow-400" id="targetNumber">7</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-sm text-gray-400 mb-1">Confidence</div>
                                    <div class="text-3xl font-bold text-green-400" id="confidence">85%</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-800 bg-opacity-50 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-400">Confidence Level</span>
                                <span class="text-sm font-semibold" id="confidenceText">85%</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-3">
                                <div id="confidenceBar" class="bg-gradient-to-r from-green-400 to-blue-500 h-3 rounded-full transition-all duration-500" style="width: 85%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Countdown & Quick Stats -->
                <div class="space-y-6">
                    <!-- Countdown -->
                    <div class="glass-morphism rounded-xl p-6 text-center">
                        <div class="text-sm text-gray-400 mb-4">Next Update In</div>
                        <div class="countdown-circle mx-auto mb-4">
                            <div class="countdown-inner">
                                <div class="text-2xl font-bold font-mono" id="countdown">00:00</div>
                                <div class="text-xs text-gray-400">seconds</div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-400">Auto-refresh enabled</div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="glass-morphism rounded-xl p-6">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-chart-line text-blue-400 mr-2"></i>
                            Quick Stats
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">Today's Predictions</span>
                                <span class="font-bold" id="todayPredictions">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">Win Rate</span>
                                <span class="font-bold text-green-400" id="winRate">0%</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">Current Streak</span>
                                <span class="font-bold text-yellow-400" id="currentStreak">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">Best Streak</span>
                                <span class="font-bold text-purple-400" id="bestStreak">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Logic Selection -->
            <div class="glass-morphism rounded-xl p-6 mb-8">
                <h3 class="text-xl font-semibold mb-6 flex items-center">
                    <i class="fas fa-brain text-purple-400 mr-3"></i>
                    AI Logic Selection
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    <button class="logic-selector glass-morphism rounded-lg p-4 text-center active" data-logic="ultraAI">
                        <i class="fas fa-robot text-2xl mb-2 block"></i>
                        <div class="font-semibold text-sm">Ultra AI</div>
                    </button>
                    <button class="logic-selector glass-morphism rounded-lg p-4 text-center" data-logic="pattern">
                        <i class="fas fa-wave-square text-2xl mb-2 block"></i>
                        <div class="font-semibold text-sm">Pattern</div>
                    </button>
                    <button class="logic-selector glass-morphism rounded-lg p-4 text-center" data-logic="fibonacci">
                        <i class="fas fa-infinity text-2xl mb-2 block"></i>
                        <div class="font-semibold text-sm">Fibonacci</div>
                    </button>
                    <button class="logic-selector glass-morphism rounded-lg p-4 text-center" data-logic="statistical">
                        <i class="fas fa-calculator text-2xl mb-2 block"></i>
                        <div class="font-semibold text-sm">Statistical</div>
                    </button>
                    <button class="logic-selector glass-morphism rounded-lg p-4 text-center" data-logic="ml">
                        <i class="fas fa-network-wired text-2xl mb-2 block"></i>
                        <div class="font-semibold text-sm">ML Weighted</div>
                    </button>
                    <button class="logic-selector glass-morphism rounded-lg p-4 text-center" data-logic="quantum">
                        <i class="fas fa-atom text-2xl mb-2 block"></i>
                        <div class="font-semibold text-sm">Quantum</div>
                    </button>
                </div>
            </div>

            <!-- Analytics & History -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Performance Analytics -->
                <div class="glass-morphism rounded-xl p-6">
                    <h3 class="text-xl font-semibold mb-6 flex items-center">
                        <i class="fas fa-chart-area text-green-400 mr-3"></i>
                        Performance Analytics
                    </h3>
                    
                    <!-- Metrics Row -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="metric-card rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-green-400" id="totalWins">0</div>
                            <div class="text-xs text-gray-400 mt-1">WINS</div>
                        </div>
                        <div class="metric-card rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-red-400" id="totalLosses">0</div>
                            <div class="text-xs text-gray-400 mt-1">LOSSES</div>
                        </div>
                        <div class="metric-card rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-400" id="accuracy">0%</div>
                            <div class="text-xs text-gray-400 mt-1">ACCURACY</div>
                        </div>
                    </div>

                    <!-- Chart -->
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>

                <!-- Recent History -->
                <div class="glass-morphism rounded-xl p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold flex items-center">
                            <i class="fas fa-history text-yellow-400 mr-3"></i>
                            Recent History
                        </h3>
                        <button onclick="clearHistory()" class="px-4 py-2 bg-red-500 bg-opacity-20 border border-red-500 rounded-lg text-red-400 hover:bg-opacity-30 transition-all text-sm">
                            <i class="fas fa-trash mr-1"></i> Clear
                        </button>
                    </div>
                    <div id="historyContainer" class="space-y-3 max-h-80 overflow-y-auto">
                        <div class="text-center text-gray-400 py-8">
                            <i class="fas fa-clock text-4xl mb-4 block opacity-50"></i>
                            <div>No prediction history</div>
                            <div class="text-sm">Start making predictions to see history</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Status -->
            <div class="glass-morphism rounded-xl p-6">
                <h3 class="text-xl font-semibold mb-6 flex items-center">
                    <i class="fas fa-server text-blue-400 mr-3"></i>
                    System Status & Information
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-4">
                        <h4 class="font-semibold text-gray-300">Connection Status</h4>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-400">API Server</span>
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse"></div>
                                    <span class="text-green-400 text-sm">Online</span>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-400">Prediction Engine</span>
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse"></div>
                                    <span class="text-green-400 text-sm">Active</span>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-400">Real-time Sync</span>
                                <div class="flex items-center">
                                    <div class="loading-spinner mr-2" style="width: 12px; height: 12px; border-width: 2px;"></div>
                                    <span class="text-yellow-400 text-sm">Syncing</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <h4 class="font-semibold text-gray-300">Session Info</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-400">Session Start</span>
                                <span class="text-sm" id="sessionStart">--:--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-400">Total Predictions</span>
                                <span class="text-sm" id="totalPredictions">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-400">Last Update</span>
                                <span class="text-sm" id="lastUpdate">Never</span>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <h4 class="font-semibold text-gray-300">Version Info</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-400">Version</span>
                                <span class="text-sm">v3.0 Pro</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-400">Build</span>
                                <span class="text-sm">2024.12.19</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-400">Platform</span>
                                <span class="text-sm">Web</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let predictionHistory = JSON.parse(localStorage.getItem('bnPredictionHistory')) || [];
        let currentLogicType = 'ultraAI';
        let lastFetchedPeriod = null;
        let performanceChart = null;
        let currentStreak = 0;
        let bestStreak = parseInt(localStorage.getItem('bnBestStreak')) || 0;
        let sessionStart = new Date().toLocaleTimeString();
        let updateInterval = null;
        let countdownInterval = null;

        // Prediction Algorithms
        const predictionAlgorithms = {
            ultraAI: function(history) {
                if (history.length < 3) {
                    return { prediction: Math.random() > 0.5 ? "BIG" : "SMALL", confidence: 65 };
                }
                
                const recent = history.slice(0, 5);
                const weights = [0.4, 0.3, 0.2, 0.07, 0.03];
                let bigScore = 0, smallScore = 0;
                
                recent.forEach((item, index) => {
                    if (item.actualResult !== undefined) {
                        const weight = weights[index] || 0.01;
                        if (item.actualResult >= 5) {
                            smallScore += weight; // Inverse prediction
                        } else {
                            bigScore += weight;
                        }
                    }
                });
                
                const prediction = bigScore > smallScore ? "BIG" : "SMALL";
                const confidence = Math.min(95, 60 + Math.abs(bigScore - smallScore) * 100);
                
                return { prediction, confidence };
            },

            pattern: function(history) {
                if (history.length < 4) {
                    return { prediction: Math.random() > 0.5 ? "BIG" : "SMALL", confidence: 55 };
                }
                
                const recent = history.filter(h => h.actualResult !== undefined).slice(0, 6);
                const pattern = recent.map(h => h.actualResult >= 5 ? 1 : 0);
                
                // Check for alternating pattern
                let alternating = true;
                for (let i = 1; i < pattern.length; i++) {
                    if (pattern[i] === pattern[i-1]) alternating = false;
                }
                
                if (alternating && pattern.length >= 3) {
                    const prediction = pattern[0] === 1 ? "SMALL" : "BIG";
                    return { prediction, confidence: 82 };
                }
                
                // Look for streaks
                let streak = 1;
                for (let i = 1; i < pattern.length; i++) {
                    if (pattern[i] === pattern[0]) streak++;
                    else break;
                }
                
                if (streak >= 3) {
                    const prediction = pattern[0] === 1 ? "SMALL" : "BIG";
                    return { prediction, confidence: 75 };
                }
                
                const prediction = Math.random() > 0.5 ? "BIG" : "SMALL";
                return { prediction, confidence: 58 };
            },

            fibonacci: function(history) {
                const validHistory = history.filter(h => h.actualResult !== undefined);
                if (validHistory.length < 3) {
                    return { prediction: Math.random() > 0.5 ? "BIG" : "SMALL", confidence: 60 };
                }
                
                const fibSeq = [1, 1, 2, 3, 5, 8];
                const recent = validHistory.slice(0, 6);
                let matches = 0;
                
                recent.forEach((item, index) => {
                    if (index < fibSeq.length && item.actualResult === fibSeq[index]) {
                        matches++;
                    }
                });
                
                const confidence = 55 + matches * 7;
                const prediction = matches % 2 === 0 ? "BIG" : "SMALL";
                
                return { prediction, confidence };
            },

            statistical: function(history) {
                const validHistory = history.filter(h => h.actualResult !== undefined);
                if (validHistory.length < 10) {
                    return { prediction: Math.random() > 0.5 ? "BIG" : "SMALL", confidence: 50 };
                }
                
                const recent20 = validHistory.slice(0, 20);
                const bigCount = recent20.filter(h => h.actualResult >= 5).length;
                const smallCount = recent20.length - bigCount;
                
                const bigPercentage = bigCount / recent20.length;
                const deviation = Math.abs(bigPercentage - 0.5);
                
                // Predict the less frequent outcome
                const prediction = bigPercentage > 0.5 ? "SMALL" : "BIG";
                const confidence = Math.min(88, 50 + deviation * 80);
                
                return { prediction, confidence };
            },

            ml: function(history) {
                const validHistory = history.filter(h => h.actualResult !== undefined);
                if (validHistory.length < 7) {
                    return { prediction: Math.random() > 0.5 ? "BIG" : "SMALL", confidence: 65 };
                }
                
                const recent = validHistory.slice(0, 10);
                let score = 0;
                const weights = [0.25, 0.2, 0.15, 0.12, 0.1, 0.08, 0.05, 0.03, 0.02];
                
                recent.forEach((item, index) => {
                    const weight = weights[index] || 0.01;
                    score += item.actualResult * weight;
                });
                
                // Calculate variance for confidence
                const avg = recent.reduce((sum, h) => sum + h.actualResult, 0) / recent.length;
                let variance = recent.reduce((sum, h) => sum + Math.pow(h.actualResult - avg, 2), 0) / recent.length;
                
                const prediction = score > 4.5 ? "SMALL" : "BIG";
                const confidence = Math.min(90, 60 + Math.abs(score - 4.5) * 10 + variance * 2);
                
                return { prediction, confidence };
            },

            quantum: function(history) {
                const validHistory = history.filter(h => h.actualResult !== undefined);
                if (validHistory.length === 0) {
                    return { prediction: Math.random() > 0.5 ? "BIG" : "SMALL", confidence: 50 };
                }
                
                // Quantum-inspired superposition
                const recent = validHistory.slice(0, 5);
                const entropy = this.calculateEntropy(recent.map(h => h.actualResult));
                
                // Quantum state collapse simulation
                const quantumPhase = Math.random() * Math.PI * 2;
                const interference = Math.sin(quantumPhase + entropy) * Math.cos(quantumPhase * 0.5);
                
                const prediction = interference > 0 ? "BIG" : "SMALL";
                const confidence = 45 + Math.abs(interference) * 30 + entropy * 5;
                
                return { prediction, confidence: Math.min(85, confidence) };
            },

            calculateEntropy: function(values) {
                const freq = {};
                values.forEach(v => freq[v] = (freq[v] || 0) + 1);
                
                let entropy = 0;
                const total = values.length;
                Object.values(freq).forEach(count => {
                    const p = count / total;
                    entropy -= p * Math.log2(p || 1);
                });
                
                return entropy;
            }
        };

        // API Functions
        async function fetchLatestResult() {
            try {
                const response = await fetch("https://api.bdg88zf.com/api/webapi/GetNoaverageEmerdList", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        pageSize: 10,
                        pageNo: 1,
                        typeId: 1,
                        language: 0,
                        random: "4a0522c6ecd8410496260e686be2a57c",
                        signature: "334B5E70A0C9B8918B0B15E517E2069C",
                        timestamp: Math.floor(Date.now() / 1000)
                    })
                });
                
                const data = await response.json();
                return data?.data?.list?.[0] || null;
            } catch (error) {
                console.error("API Error:", error);
                showNotification("Connection Error", "Failed to fetch game data", "error");
                return null;
            }
        }

        // Prediction Functions
        function generatePrediction() {
            const algorithm = predictionAlgorithms[currentLogicType];
            const result = algorithm(predictionHistory);
            
            const targetNumbers = result.prediction === "BIG" ? [0, 1, 2, 3, 4] : [5, 6, 7, 8, 9];
            const targetNumber = targetNumbers[Math.floor(Math.random() * targetNumbers.length)];
            
            return {
                prediction: result.prediction,
                confidence: Math.round(result.confidence),
                targetNumber: targetNumber
            };
        }

        async function updatePrediction() {
            try {
                const latestResult = await fetchLatestResult();
                if (!latestResult) return;

                const currentPeriod = latestResult.issueNumber;
                const nextPeriod = (BigInt(currentPeriod) + 1n).toString().slice(-4);

                // Check if we have a pending prediction to resolve
                if (predictionHistory.length > 0 && predictionHistory[0].status === 'pending') {
                    const pendingPrediction = predictionHistory[0];
                    if (pendingPrediction.period === currentPeriod.slice(-4)) {
                        // Resolve the pending prediction
                        const actualNumber = parseInt(latestResult.number);
                        resolvePrediction(pendingPrediction, actualNumber);
                    }
                }

                // Generate new prediction if period changed
                if (lastFetchedPeriod !== currentPeriod) {
                    const newPrediction = generatePrediction();
                    
                    const predictionData = {
                        id: Date.now(),
                        period: nextPeriod,
                        prediction: newPrediction.prediction,
                        targetNumber: newPrediction.targetNumber,
                        confidence: newPrediction.confidence,
                        logic: currentLogicType,
                        timestamp: new Date().toLocaleTimeString(),
                        status: 'pending',
                        actualResult: undefined
                    };

                    // Add to beginning of history
                    predictionHistory.unshift(predictionData);
                    
                    // Keep only last 50 predictions
                    if (predictionHistory.length > 50) {
                        predictionHistory = predictionHistory.slice(0, 50);
                    }

                    updateUI(predictionData);
                    lastFetchedPeriod = currentPeriod;
                    
                    showNotification(
                        "New Prediction Generated", 
                        `${newPrediction.prediction} with ${newPrediction.confidence}% confidence`, 
                        "info"
                    );
                }

                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                
            } catch (error) {
                console.error("Update error:", error);
                showNotification("Update Error", "Failed to update prediction", "error");
            }
        }

        function resolvePrediction(prediction, actualNumber) {
            prediction.actualResult = actualNumber;
            prediction.status = checkWin(prediction, actualNumber) ? 'win' : 'loss';
            
            if (prediction.status === 'win') {
                currentStreak++;
                if (currentStreak > bestStreak) {
                    bestStreak = currentStreak;
                    localStorage.setItem('bnBestStreak', bestStreak);
                }
                showNotification("🎉 WIN!", `Correct prediction! Streak: ${currentStreak}`, "success");
            } else {
                currentStreak = 0;
                showNotification("❌ LOSS", "Better luck next time!", "error");
            }
            
            updateStats();
            updateHistoryDisplay();
            updateChart();
            saveToStorage();
        }

        function checkWin(prediction, actualNumber) {
            const actualCategory = actualNumber >= 5 ? "BIG" : "SMALL";
            return (actualNumber === prediction.targetNumber) || (actualCategory === prediction.prediction);
        }

        // UI Update Functions
        function updateUI(currentPrediction = null) {
            if (currentPrediction) {
                document.getElementById('currentPeriod').textContent = currentPrediction.period;
                document.getElementById('currentLogic').textContent = getLogicDisplayName(currentPrediction.logic);
                
                const predictionDisplay = document.getElementById('predictionDisplay');
                predictionDisplay.textContent = currentPrediction.prediction;
                predictionDisplay.className = `inline-block px-8 py-4 rounded-2xl text-4xl font-bold prediction-${currentPrediction.prediction.toLowerCase()}`;
                
                document.getElementById('targetNumber').textContent = currentPrediction.targetNumber;
                document.getElementById('confidence').textContent = currentPrediction.confidence + '%';
                document.getElementById('confidenceText').textContent = currentPrediction.confidence + '%';
                document.getElementById('confidenceBar').style.width = currentPrediction.confidence + '%';
            }
            
            updateStats();
            updateHistoryDisplay();
            updateChart();
        }

        function updateStats() {
            const completedPredictions = predictionHistory.filter(p => p.status !== 'pending');
            const wins = completedPredictions.filter(p => p.status === 'win').length;
            const losses = completedPredictions.filter(p => p.status === 'loss').length;
            const winRate = completedPredictions.length > 0 ? (wins / completedPredictions.length * 100) : 0;

            document.getElementById('todayPredictions').textContent = predictionHistory.length;
            document.getElementById('winRate').textContent = winRate.toFixed(1) + '%';
            document.getElementById('currentStreak').textContent = currentStreak;
            document.getElementById('bestStreak').textContent = bestStreak;
            document.getElementById('totalWins').textContent = wins;
            document.getElementById('totalLosses').textContent = losses;
            document.getElementById('accuracy').textContent = winRate.toFixed(1) + '%';
            document.getElementById('totalPredictions').textContent = predictionHistory.length;
            document.getElementById('sessionStart').textContent = sessionStart;
        }

        function updateHistoryDisplay() {
            const container = document.getElementById('historyContainer');
            
            if (predictionHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <i class="fas fa-clock text-4xl mb-4 block opacity-50"></i>
                        <div>No prediction history</div>
                        <div class="text-sm">Start making predictions to see history</div>
                    </div>
                `;
                return;
            }

            const historyHTML = predictionHistory.slice(0, 10).map(prediction => {
                const statusClass = {
                    'win': 'history-win',
                    'loss': 'history-loss',
                    'pending': 'history-pending'
                }[prediction.status];

                const statusIcon = {
                    'win': 'fas fa-check-circle text-green-400',
                    'loss': 'fas fa-times-circle text-red-400',
                    'pending': 'fas fa-clock text-yellow-400'
                }[prediction.status];

                const statusBadge = {
                    'win': 'status-win',
                    'loss': 'status-loss',
                    'pending': 'status-pending'
                }[prediction.status];

                return `
                    <div class="history-card ${statusClass} glass-morphism rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center">
                                        <span class="font-semibold">Period ${prediction.period}</span>
                                        <span class="ml-2 px-2 py-1 bg-gray-700 rounded text-xs">${getLogicDisplayName(prediction.logic)}</span>
                                    </div>
                                    <div class="px-3 py-1 ${statusBadge} rounded-full text-xs font-semibold">
                                        ${prediction.status.toUpperCase()}
                                    </div>
                                </div>
                                <div class="grid grid-cols-4 gap-3 text-sm">
                                    <div>
                                        <div class="text-gray-400 text-xs">Prediction</div>
                                        <div class="font-semibold text-${prediction.prediction === 'BIG' ? 'green' : 'red'}-400">
                                            ${prediction.prediction}
                                        </div>
                                    </div>
                                    <div>
                                        <div class="text-gray-400 text-xs">Target</div>
                                        <div class="font-semibold text-yellow-400">${prediction.targetNumber}</div>
                                    </div>
                                    <div>
                                        <div class="text-gray-400 text-xs">Result</div>
                                        <div class="font-semibold">${prediction.actualResult !== undefined ? prediction.actualResult : '-'}</div>
                                    </div>
                                    <div>
                                        <div class="text-gray-400 text-xs">Confidence</div>
                                        <div class="font-semibold text-blue-400">${prediction.confidence}%</div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center mt-3 text-xs text-gray-400">
                                    <span>${prediction.timestamp}</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <i class="${statusIcon} text-xl"></i>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = historyHTML;
        }

        function updateChart() {
            if (!performanceChart) return;

            const completed = predictionHistory.filter(p => p.status !== 'pending').slice(0, 20).reverse();
            const labels = completed.map(p => `P${p.period}`);
            const winRates = [];

            let cumulativeWins = 0;
            completed.forEach((prediction, index) => {
                if (prediction.status === 'win') cumulativeWins++;
                const rate = ((cumulativeWins / (index + 1)) * 100);
                winRates.push(rate);
            });

            performanceChart.data.labels = labels;
            performanceChart.data.datasets[0].data = winRates;
            performanceChart.update('none');
        }

        // Utility Functions
        function getLogicDisplayName(logic) {
            const names = {
                'ultraAI': 'Ultra AI',
                'pattern': 'Pattern',
                'fibonacci': 'Fibonacci',
                'statistical': 'Statistical',
                'ml': 'ML Weighted',
                'quantum': 'Quantum'
            };
            return names[logic] || logic;
        }

        function showNotification(title, message, type = "info") {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const titleEl = document.getElementById('notificationTitle');
            const messageEl = document.getElementById('notificationMessage');

            const icons = {
                success: 'fas fa-check-circle text-green-400',
                error: 'fas fa-exclamation-circle text-red-400',
                info: 'fas fa-info-circle text-blue-400',
                warning: 'fas fa-exclamation-triangle text-yellow-400'
            };

            icon.innerHTML = `<i class="${icons[type]} text-xl"></i>`;
            titleEl.textContent = title;
            messageEl.textContent = message;

            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        function hideNotification() {
            document.getElementById('notification').classList.remove('show');
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all prediction history?')) {
                predictionHistory = [];
                currentStreak = 0;
                saveToStorage();
                updateUI();
                showNotification("History Cleared", "All prediction history has been cleared", "info");
            }
        }

        function saveToStorage() {
            localStorage.setItem('bnPredictionHistory', JSON.stringify(predictionHistory));
        }

        function updateCountdown() {
            const now = new Date();
            const nextMinute = new Date(now);
            nextMinute.setMinutes(now.getMinutes() + 1, 0, 0);
            const seconds = Math.floor((nextMinute - now) / 1000);
            
            document.getElementById('countdown').textContent = `00:${seconds.toString().padStart(2, '0')}`;
        }

        // Event Listeners
        document.querySelectorAll('.logic-selector').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.logic-selector').forEach(b => b.classList.remove('active'));
                button.classList.add('active');
                currentLogicType = button.dataset.logic;
                document.getElementById('currentLogic').textContent = getLogicDisplayName(currentLogicType);
                showNotification("AI Logic Changed", `Switched to ${getLogicDisplayName(currentLogicType)}`, "info");
            });
        });

        // Initialize Chart
        function initChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Win Rate %',
                        data: [],
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#10B981',
                        pointBorderColor: '#FFFFFF',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#9CA3AF',
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#9CA3AF'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // Initialize Application
        function init() {
            initChart();
            updateUI();
            updatePrediction();
            
            // Set up intervals
            updateInterval = setInterval(updatePrediction, 5000);
            countdownInterval = setInterval(updateCountdown, 1000);
            
            showNotification("System Online", "BN Last King prediction system is ready!", "success");
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
